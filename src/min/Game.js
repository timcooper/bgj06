/*! rainbows 27-10-2013 */
var Main=Main||{};Main.Game=function(a){this.game=a},Main.Game.prototype={LEVELS:{1:{y:80},2:{y:208},3:{y:336}},COLORS:{red:{particle:"particleRed",gate:"gateRed",end:"endRed",particleFrame:1},yellow:{particle:"particleYellow",gate:"gateYellow",end:"endYellow",particleFrame:2},blue:{particle:"particleBlue",gate:"gateBlue",end:"endBlue",particleFrame:3},orange:{particle:"particleOrange",gate:"gateOrange",end:"endOrange",particleFrame:4},green:{particle:"particleGreen",gate:"gateGreen",end:"endGreen",particleFrame:5},purple:{particle:"particlePurple",gate:"gatePurple",end:"endPurple",particleFrame:6},white:{particle:"particleWhite",particleFrame:0},black:{particle:"particle",particleFrame:7}},player:Phaser.Sprite,enabledColors:["red"],redKey:null,yellowKey:null,blueKey:null,bg:null,barriers:[],gates:[],maxVelocity:0,currentColor:"black",tween:null,gatesCleared:0,lastTime:0,emitter:null,rumbleSpeed:50,rumbleTime:1500,music:null,preload:function(){},create:function(){this.game.world.setBounds(0,0,12800,this.game.height),this.bg=this.game.add.tileSprite(0,0,this.game.width,this.game.height,"background"),this.bg.fixedToCamera=!0,this.player=this.game.add.sprite(0,208,"particle"),this.player.anchor.setTo(.5,.5),this.music=this.game.add.audio("gameLoop"),this.music.play("",0,.2,!0),this.player.body.acceleration.x=16,this.player.body.velocity.x=100,this.player.body.maxVelocity.x=640,this.game.camera.follow(this.player),Math.max(this.game.width,this.game.height)/8,this.game.camera.deadzone=new Phaser.Rectangle(0,0,200,this.game.height),this.enableColors(),this.redKey=this.game.input.keyboard.addKey(Phaser.Keyboard.ONE),this.yellowKey=this.game.input.keyboard.addKey(Phaser.Keyboard.TWO),this.blueKey=this.game.input.keyboard.addKey(Phaser.Keyboard.THREE),this.barriers=this.game.add.group(),this.barriers.createMultiple(25,"barrier1"),this.barriers.setAll("anchor.x",.5),this.barriers.setAll("body.width",6),this.barriers.setAll("body.x",26),this.barriers.setAll("outOfBoundsKill",!0),this.gates=this.game.add.group();for(var a in this.COLORS)this.COLORS[a].emitter=this.game.add.emitter(0,0,200),this.COLORS[a].emitter.makeParticles("particles",[0,this.COLORS[a].particleFrame]),this.COLORS[a].emitter.gravity=2,this.COLORS[a].emitter.particleDrag.x=500,this.COLORS[a].emitter.bounce.setTo(.5,.5);this.generateLevel(),this.player.bringToTop()},update:function(){this.bg.tilePosition.x=-this.game.camera.x,this.bg.tilePosition.y=-this.game.camera.y,this.setVerticalLevel(),this.game.physics.collide(this.barriers,this.player,this.hitWall,null,this),this.colorBlack(),this.redKey.isDown&&this.colorRed(),this.yellowKey.isDown&&this.colorYellow(),this.blueKey.isDown&&this.colorBlue(),this.atEnd()&&this.finish(!0)},atEnd:function(){return this.player.x>=this.game.world.width},hitWall:function(a,b){var c=this.gates.getAt(this.barriers.getIndex(b)).key.slice(4).toLowerCase();if(clearInterval(this.rumbleInterval),this.rumbleInterval=setInterval(this.rumble,this.rumbleSpeed,this.game.camera,10,this.player.body.velocity.x>300?80:50),clearInterval(this.rumbleTime),this.rumbleTime=setInterval(this.stopRumble,10*this.rumbleSpeed,this.game.camera,this.rumbleInterval),this.COLORS[c].emitter.setXSpeed(-(this.player.body.velocity.x/3)-25,this.player.body.velocity.x),this.COLORS[c].emitter.setYSpeed(-(this.player.body.velocity.x/3),this.player.body.velocity.x/3),this.COLORS[c].emitter.x=b.x,this.COLORS[c].emitter.y=a.y,this.COLORS[c].emitter.start(!0,2e3,null,30),b.alive&&("barrier1"==b.key&&this.player.center.y<144||"barrier2"==b.key&&this.player.center.y<272&&this.player.center.x>144||"barrier3"==b.key&&this.player.center.y>272))if(b.alive=!1,this.currentColor===c){var d=this.game.add.audio("gateDischarge"+this.game.rnd.integerInRange(1,4));d.play("",0,.1),this.gatesCleared++,this.player.body.velocity.x+=128}else this.finish(!1);else this.finish(!1)},finish:function(a){var b=Main.MainMenu.prototype.unlockedLevels,c=Main.MainMenu.prototype.currentLevel,d=Main.MainMenu.prototype.highestGates;this.music.stop(),clearInterval(this.rumbleInterval),clearInterval(this.rumbleTime),a&&b.length<6?-1===b.indexOf(c+1)&&b.push(c+1):-1===b.indexOf(c+1)&&(d[c]=!d.hasOwnProperty(c)||parseInt(d[c])<this.gatesCleared?this.gatesCleared:d[c]),this.lastTime=this.game.time.now,this.game.state.start("mainmenu",!0)},colorBlack:function(){this.currentColor="black",this.player.loadTexture(this.COLORS.black.particle,0)},colorRed:function(){this.yellowKey.isDown&&this.blueKey.isDown&&this.canChange("white")?(this.currentColor="white",this.player.loadTexture(this.COLORS.white.particle,0)):this.yellowKey.isDown&&this.canChange("orange")?(this.currentColor="orange",this.player.loadTexture(this.COLORS.orange.particle,0)):this.blueKey.isDown&&this.canChange("purple")?(this.currentColor="purple",this.player.loadTexture(this.COLORS.purple.particle,0)):(this.currentColor="red",this.player.loadTexture(this.COLORS.red.particle,0))},colorYellow:function(){this.redKey.isDown&&this.blueKey.isDown&&this.canChange("white")?(this.currentColor="white",this.player.loadTexture(this.COLORS.white.particle,0)):this.redKey.isDown&&this.canChange("orange")?(this.currentColor="orange",this.player.loadTexture(this.COLORS.orange.particle,0)):this.blueKey.isDown&&this.canChange("green")?(this.currentColor="green",this.player.loadTexture(this.COLORS.green.particle,0)):this.canChange("yellow")&&(this.currentColor="yellow",this.player.loadTexture(this.COLORS.yellow.particle,0))},colorBlue:function(){this.yellowKey.isDown&&this.redKey.isDown&&this.canChange("white")?(this.currentColor="white",this.player.loadTexture(this.COLORS.white.particle,0)):this.yellowKey.isDown&&this.canChange("green")?(this.currentColor="green",this.player.loadTexture(this.COLORS.green.particle,0)):this.redKey.isDown&&this.canChange("purple")?(this.currentColor="purple",this.player.loadTexture(this.COLORS.purple.particle,0)):this.canChange("blue")&&(this.currentColor="blue",this.player.loadTexture(this.COLORS.blue.particle,0))},setVerticalLevel:function(){var a=this.game.input.activePointer.y,b=this.game.add.tween(this.player);144>a?b.stop().to({y:this.LEVELS[1].y},250,Phaser.Easing.Cubic.Out,!0):272>a?b.stop().to({y:this.LEVELS[2].y},250,Phaser.Easing.Cubic.Out,!0):b.stop().to({y:this.LEVELS[3].y},250,Phaser.Easing.Cubic.Out,!0)},enableColors:function(){var a=0;for(var b in this.COLORS)a++,a<=Main.MainMenu.prototype.currentLevel&&this.enabledColors.push(b)},generateLevel:function(){for(var a=null,b=0;b<this.barriers.length;b++){var c=this.game.rnd.integerInRange(1,4),d=this.enabledColors[this.game.rnd.integerInRange(1,this.enabledColors.length+1)-1],e=this.COLORS[d],f=512*(b+1);if(a=this.barriers.getFirstDead(),a.body.customSeparateX=!0,a.body.customSeparateY=!0,this.barriers.length-1===b){var g=this.game.add.sprite(0,0,e.end);g.centerOn(12691,this.LEVELS[c].y)}c>1&&a.loadTexture("barrier"+c,0);var h=this.game.add.sprite(0,0,e.gate);h.centerOn(f,this.LEVELS[c].y),this.gates.add(h),a.reset(f,0)}},canChange:function(a){return-1!==this.enabledColors.indexOf(a)},randomColor:function(){var a,b=0;for(var c in this.COLORS)this.canChange(c)&&Math.random()<1/++b&&(a=c);return a},rumble:function(a,b,c,d){b=b||5,c=c||5,d=d||1;var e=Math.floor(Math.random()*(b+1))-b/2,f=Math.floor(Math.random()*(c+1))-c/2;Math.floor(Math.random()*(d+1))-d/2,e=0===e&&0!==b?Math.random()<.5?1:-1:e,f=0===f&&0!==c?Math.random()<.5?1:-1:f,a.x+=e,a.y+=f},stopRumble:function(a,b){clearInterval(b)},writeDebug:function(){var a=window.document.getElementById("debug-velocity"),b=Math.round(this.player.body.velocity.x),c=window.document.getElementById("debug-dist");b>this.maxVelocity&&(this.maxVelocity=b),a.innerHTML=b,c.innerHTML=Math.round(this.player.center.x+this.game.camera.x)}};